<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç®€å†åŒ¹é… - å‘ç°å¥½å·¥ä½œ</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>

    <header class="header">
        <div class="header-content">
            <h1>ç²¾å‡†èŒä½åŒ¹é…</h1>
            <div class="header-actions">
                <div class="upload-container">
                    <input type="file" id="resumeFile" accept="application/pdf" style="display: none;">
                    <label for="resumeFile" class="upload-btn">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path
                                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z" />
                        </svg>
                        ä¸Šä¼  PDF ç®€å†è¿›è¡ŒåŒ¹é…
                    </label>
                </div>
                <button id="refreshBtn" class="refresh-btn" onclick="refreshJobs()">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path
                            d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                    </svg>
                    åˆ·æ–°
                </button>
                <button id="resetBtn" class="reset-btn" style="display: none;" onclick="resetState()">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path
                            d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z" />
                    </svg>
                    è¿˜åŸ
                </button>
            </div>
            <div id="uploadStatus" class="upload-status"></div>
        </div>
    </header>

    <main class="main-container">
        <div id="jobGrid" class="job-grid">
            <!-- Job cards will be injected here via JavaScript -->
        </div>
        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p id="loadingText">æ­£åœ¨åŠ è½½èŒä½...</p>
        </div>
    </main>

    <!-- Job Detail Modal -->
    <div id="jobModal" class="modal-overlay" onclick="closeModalOnOverlay(event)">
        <div class="modal-card">
            <button class="modal-close" onclick="closeModal()">âœ•</button>

            <div class="modal-header">
                <div class="modal-salary" id="modalSalary"></div>
                <div class="modal-title" id="modalTitle"></div>
                <div class="modal-reqs" id="modalReqs"></div>
            </div>

            <div class="modal-tags" id="modalTags"></div>

            <div class="modal-divider"></div>

            <div class="modal-analysis-section">
                <div class="modal-analysis-title">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                        <path
                            d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1v2h-1v1a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-1H1v-2h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2M7.5 13A2.5 2.5 0 0 0 5 15.5 2.5 2.5 0 0 0 7.5 18 2.5 2.5 0 0 0 10 15.5 2.5 2.5 0 0 0 7.5 13m9 0a2.5 2.5 0 0 0-2.5 2.5 2.5 2.5 0 0 0 2.5 2.5 2.5 2.5 0 0 0 2.5-2.5 2.5 2.5 0 0 0-2.5-2.5z" />
                    </svg>
                    AI èŒä½æ·±åº¦è§£æ
                </div>
                <div id="modalAnalysisContent" class="modal-analysis-content">
                    <div class="analysis-loading">
                        <div class="spinner spinner-sm"></div>
                        <span>AI æ­£åœ¨åˆ†æè¿™ä¸ªèŒä½...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentResumeId = null;
        let analysisCache = {}; // Cache: jobId -> analysis text
        let currentJobData = null;

        // Pagination state
        let currentPage = 0;
        const pageSize = 10;
        let isLoading = false;
        let hasMore = true;

        document.getElementById('resumeFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.textContent = 'ä¸Šä¼ ä¸­...';
            statusDiv.className = 'upload-status uploading';

            try {
                const response = await fetch('/api/resume/upload', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    currentResumeId = data.resumeId;
                    statusDiv.textContent = 'ç®€å†å·²ä¸Šä¼ ï¼ŒAI æ­£åœ¨åˆ†æå¹¶å¯»æ‰¾åŒ¹é…...';
                    statusDiv.className = 'upload-status success';

                    // Show reset button
                    document.getElementById('resetBtn').style.display = 'inline-flex';

                    // Reset and fetch
                    refreshJobs();

                    // Poll for initial match results (backend processing might be async)
                    setTimeout(refreshJobs, 2000);
                } else {
                    statusDiv.textContent = 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•';
                    statusDiv.className = 'upload-status error';
                }
            } catch (error) {
                statusDiv.textContent = 'ç½‘ç»œé”™è¯¯';
                statusDiv.className = 'upload-status error';
            }
        });

        function resetState() {
            currentResumeId = null;
            analysisCache = {};
            currentJobData = null;

            // Reset UI
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.textContent = '';
            statusDiv.className = 'upload-status';

            document.getElementById('resetBtn').style.display = 'none';
            document.getElementById('resumeFile').value = '';

            refreshJobs();
        }

        function refreshJobs() {
            currentPage = 0;
            hasMore = true;
            document.getElementById('jobGrid').innerHTML = '';
            fetchJobs(true);
        }

        async function fetchJobs(isInitial = false) {
            if (isLoading || !hasMore) return;

            isLoading = true;
            const loader = document.getElementById('loadingIndicator');
            loader.style.display = 'flex';

            let url = `/api/jobs/match?page=${currentPage}&size=${pageSize}`;
            if (currentResumeId) {
                url += `&resumeId=${currentResumeId}`;
            }

            try {
                const response = await fetch(url);
                const jobs = await response.json();

                if (jobs.length < pageSize) {
                    hasMore = false;
                }

                renderJobs(jobs, isInitial);
                currentPage++;
            } catch (error) {
                console.error('Failed to fetch jobs', error);
            } finally {
                isLoading = false;
                loader.style.display = 'none';
            }
        }

        function renderJobs(jobs, clearGrid = false) {
            const grid = document.getElementById('jobGrid');
            if (clearGrid) grid.innerHTML = '';

            if (jobs.length === 0 && grid.children.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #888;">æš‚æ—¶æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„èŒä½</div>';
                return;
            }

            jobs.forEach(job => {
                const skills = job.skillsRequirement.slice(0, 3).map(s => `<span class="tag">${s}</span>`).join('');
                const card = document.createElement('div');
                card.className = 'job-card';
                card.innerHTML = `
                    <div class="card-salary">${job.salary}</div>
                    <div class="card-title">${job.title}</div>
                    <div class="card-reqs">
                        <span><svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg> ${job.location}</span>
                        <span>ğŸ“ ${job.educationRequirement}</span>
                        <span>ğŸ“… ${job.graduationTimeRange}å±Š</span>
                    </div>
                    <div class="card-tags">
                        ${skills}
                        ${job.skillsRequirement.length > 3 ? `<span class="tag">+${job.skillsRequirement.length - 3}</span>` : ''}
                    </div>
                    <div class="card-footer">
                        <span>ä¸“ä¸šè¦æ±‚: ${job.targetMajor}</span>
                        <span class="card-detail-hint">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… â†’</span>
                    </div>
                `;
                card.addEventListener('click', () => openJobModal(job));
                grid.appendChild(card);
            });
        }

        function openJobModal(job) {
            currentJobData = job;
            const modal = document.getElementById('jobModal');

            // Populate header
            document.getElementById('modalSalary').textContent = job.salary;
            document.getElementById('modalTitle').textContent = job.title;
            document.getElementById('modalReqs').innerHTML = `
                <span><svg viewBox="0 0 24 24" width="13" height="13" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>&nbsp;${job.location}</span>
                <span>ğŸ“ ${job.educationRequirement}</span>
                <span>ğŸ“… ${job.graduationTimeRange}å±Š</span>
                <span>ğŸ¯ ${job.targetMajor}</span>
            `;

            // Populate tags
            const allSkills = job.skillsRequirement.map(s => `<span class="tag">${s}</span>`).join('');
            document.getElementById('modalTags').innerHTML = allSkills;

            // Show modal
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Load analysis (or use cache)
            loadAnalysis(job);
        }

        async function loadAnalysis(job) {
            const contentDiv = document.getElementById('modalAnalysisContent');
            const cacheKey = job.id || job.title;

            if (analysisCache[cacheKey]) {
                contentDiv.innerHTML = formatAnalysis(analysisCache[cacheKey]);
                return;
            }

            // Show loading
            contentDiv.innerHTML = `
                <div class="analysis-loading">
                    <div class="spinner spinner-sm"></div>
                    <span>AI æ­£åœ¨æ·±åº¦åˆ†æè¿™ä¸ªèŒä½...</span>
                </div>
            `;

            try {
                const response = await fetch('/api/jobs/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(job)
                });
                const data = await response.json();
                const analysis = data.analysis || 'æš‚æ— åˆ†æ';
                analysisCache[cacheKey] = analysis;

                // Only update if same job is still open
                if (currentJobData === job) {
                    contentDiv.innerHTML = formatAnalysis(analysis);
                }
            } catch (err) {
                if (currentJobData === job) {
                    contentDiv.innerHTML = '<p style="color:#ff4d4f;">è·å–åˆ†æå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚</p>';
                }
            }
        }

        function formatAnalysis(text) {
            // Convert markdown-like formatting to HTML
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^/, '<p>')
                .replace(/$/, '</p>');
        }

        function closeModal() {
            document.getElementById('jobModal').classList.remove('active');
            document.body.style.overflow = '';
            currentJobData = null;
        }

        function closeModalOnOverlay(e) {
            if (e.target === document.getElementById('jobModal')) {
                closeModal();
            }
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // Infinite Scroll Listener
        window.addEventListener('scroll', () => {
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
                fetchJobs();
            }
        });

        // Initial load
        refreshJobs();
    </script>
</body>

</html>